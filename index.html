<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aplikasi Pengaduan Siswa</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .chart-container {
            position: relative;
            height: 40vh;
            width: 80vw;
            max-width: 600px;
        }
        .page {
            display: none;
            animation: fadeIn 0.5s;
        }
        .page.active {
            display: block;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .toast {
            position: fixed;
            bottom: -100px;
            left: 50%;
            transform: translateX(-50%);
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            color: white;
            transition: bottom 0.5s ease-in-out;
            z-index: 1000;
        }
        .toast.show {
            bottom: 30px;
        }
        .toast.success { background-color: #22c55e; }
        .toast.error { background-color: #ef4444; }
    </style>
</head>
<body class="bg-slate-900 text-slate-200">

    <div id="app" class="max-w-4xl mx-auto p-4 md:p-6">

        <!-- Header -->
        <header id="app-header" class="bg-slate-800 shadow-md rounded-xl p-6 mb-6 hidden">
            <div class="flex justify-between items-center">
                <div>
                    <h1 class="text-2xl md:text-3xl font-bold text-white">Aplikasi Pengaduan Siswa</h1>
                    <p id="welcome-message" class="text-sm text-slate-400 mt-1"></p>
                </div>
                <div class="flex items-center space-x-4">
                     <button id="pengaturan-btn" title="Pengaturan" onclick="showPage('pengaturan')" class="p-2 rounded-full text-slate-300 hover:bg-slate-700 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
                    </button>
                    <button onclick="logout()" class="px-4 py-2 text-sm font-medium text-white bg-red-600 rounded-lg hover:bg-red-700 transition-colors flex items-center space-x-2">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg>
                        <span>Keluar</span>
                    </button>
                </div>
            </div>
             <nav id="app-nav" class="mt-4 border-t border-slate-700 pt-4">
                <!-- Navigasi dinamis -->
            </nav>
        </header>

        <!-- Main Content -->
        <main id="main-content">
            <!-- Login Page -->
            <div id="login" class="page active">
                 <div class="bg-slate-800 p-8 rounded-xl shadow-lg max-w-md mx-auto mt-16 animate-fadeIn">
                    <h2 class="text-2xl font-bold mb-2 text-center text-white">Selamat Datang</h2>
                    <p class="text-slate-400 mb-6 text-center">Silakan masuk untuk melanjutkan.</p>
                    <form id="login-form" onsubmit="handleLogin(event)">
                        <div class="mb-4">
                            <label for="user-id" class="block text-sm font-medium text-slate-300">NIS / ID Admin</label>
                            <input type="text" id="user-id" class="mt-1 block w-full p-3 bg-slate-700 border border-slate-600 text-white rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" required>
                        </div>
                        <div class="mb-6">
                            <label for="password" class="block text-sm font-medium text-slate-300">Password</label>
                            <input type="password" id="password" class="mt-1 block w-full p-3 bg-slate-700 border border-slate-600 text-white rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" required>
                        </div>
                        <p id="login-error" class="text-red-500 text-sm text-center mb-4 hidden"></p>
                        <button type="submit" class="w-full px-6 py-3 text-lg font-semibold text-white bg-blue-600 rounded-lg hover:bg-blue-700 transition-all duration-300 transform hover:scale-105">Masuk</button>
                         <div class="text-center mt-6">
                            <a href="#" onclick="handleManagementLogin(event)" class="text-sm text-blue-400 hover:text-blue-300 hover:underline">Akses Manajemen Akun (Khusus Admin)</a>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Beranda Siswa Page -->
            <div id="beranda-siswa" class="page">
                <div class="text-center mb-8">
                    <h2 class="text-xl font-semibold mb-2 text-white">Buat Laporan Baru</h2>
                    <p class="text-slate-400">Pilih kategori untuk memulai pengaduan Anda.</p>
                </div>
                <div id="category-buttons" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4 mb-8">
                    <!-- Tombol kategori akan di-generate oleh JS -->
                </div>
            </div>

            <!-- Admin Dashboard Page -->
            <div id="admin-dashboard" class="page">
                 <div class="bg-slate-800 p-6 md:p-8 rounded-xl shadow-lg">
                    <h2 class="text-2xl font-bold mb-6 text-white">Dasbor Admin</h2>
                    <!-- Stats -->
                    <div id="admin-stats" class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
                        <!-- Statistik di-generate oleh JS -->
                    </div>
                    <!-- Filters -->
                    <div class="flex flex-col md:flex-row gap-4 mb-6 p-4 bg-slate-900/50 rounded-lg">
                        <input type="text" id="search-input" onkeyup="renderAdminDashboard()" placeholder="Cari laporan..." class="w-full md:w-1/2 p-2 bg-slate-700 border border-slate-600 rounded-md">
                        <select id="filter-category" onchange="renderAdminDashboard()" class="w-full md:w-1/4 p-2 bg-slate-700 border border-slate-600 rounded-md"></select>
                        <select id="filter-status" onchange="renderAdminDashboard()" class="w-full md:w-1/4 p-2 bg-slate-700 border border-slate-600 rounded-md">
                             <option value="">Semua Status</option>
                             <option value="Diterima">Diterima</option>
                             <option value="Diproses">Diproses</option>
                             <option value="Selesai">Selesai</option>
                        </select>
                    </div>
                    <div id="admin-history-list" class="space-y-6"></div>
                 </div>
            </div>

            <!-- Admin Account Management Page -->
            <div id="manajemen-akun" class="page">
                <div class="bg-slate-800 p-6 md:p-8 rounded-xl shadow-lg">
                    <h2 class="text-2xl font-bold mb-6 text-white">Manajemen Akun Siswa</h2>
                    <!-- Add User Form -->
                    <form id="add-user-form" onsubmit="addStudent(event)" class="mb-8 p-4 bg-slate-900/50 rounded-lg">
                         <h3 class="text-lg font-semibold mb-4">Tambah Akun Siswa Baru</h3>
                         <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                             <div>
                                <label for="new-student-name" class="block text-sm font-medium text-slate-300">Nama Siswa</label>
                                <input type="text" id="new-student-name" class="mt-1 block w-full p-2 bg-slate-700 border border-slate-600 rounded-md" required>
                             </div>
                              <div>
                                <label for="new-student-id" class="block text-sm font-medium text-slate-300">NIS</label>
                                <input type="text" id="new-student-id" class="mt-1 block w-full p-2 bg-slate-700 border border-slate-600 rounded-md" required>
                             </div>
                              <div>
                                <label for="new-student-password" class="block text-sm font-medium text-slate-300">Password</label>
                                <input type="password" id="new-student-password" class="mt-1 block w-full p-2 bg-slate-700 border border-slate-600 rounded-md" required>
                             </div>
                         </div>
                         <button type="submit" class="mt-4 px-6 py-2 text-sm font-medium text-white bg-blue-600 rounded-lg hover:bg-blue-700">Tambah Akun</button>
                    </form>
                    <!-- User List -->
                    <h3 class="text-lg font-semibold mb-4">Daftar Akun Siswa</h3>
                    <div id="student-list-container" class="space-y-2"></div>
                </div>
            </div>

            <!-- Grafik Page -->
            <div id="grafik" class="page">
                 <div class="bg-slate-800 p-6 rounded-xl shadow-lg">
                    <h3 class="text-xl font-semibold mb-4 text-center text-white">Grafik Jumlah Kasus per Kategori</h3>
                    <div class="chart-container mx-auto">
                        <canvas id="complaintChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Form Laporan Page -->
            <div id="form-laporan" class="page">
                <div class="bg-slate-800 p-6 md:p-8 rounded-xl shadow-lg">
                    <h2 class="text-2xl font-bold mb-1 text-white">Buat Laporan Baru</h2>
                    <p class="text-slate-400 mb-6">Kategori: <span id="form-category-title" class="font-semibold"></span></p>
                    <form id="complaint-form" onsubmit="submitComplaint(event)">
                        <input type="hidden" id="category-input">
                        <div class="mb-4">
                            <label for="masalah" class="block text-sm font-medium text-slate-300 mb-1">Jelaskan Laporan Masalah Anda</label>
                            <textarea id="masalah" rows="6" class="w-full p-3 bg-slate-700 border border-slate-600 text-white rounded-lg focus:ring-blue-500 focus:border-blue-500" placeholder="Tuliskan detail masalah yang Anda hadapi..." required></textarea>
                        </div>
                        <div class="mb-4">
                             <label for="attachment" class="block text-sm font-medium text-slate-300 mb-1">Lampirkan Bukti (Opsional)</label>
                             <input type="file" id="attachment" accept="image/*" class="w-full text-sm text-slate-400 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-500/10 file:text-blue-300 hover:file:bg-blue-500/20">
                        </div>
                        <div class="mb-6">
                            <label class="flex items-center">
                                <input type="checkbox" id="anonim" class="h-4 w-4 text-blue-600 bg-slate-700 border-slate-600 rounded focus:ring-blue-500">
                                <span class="ml-2 text-sm text-slate-300">Kirim sebagai Anonim</span>
                            </label>
                        </div>
                        <div class="flex items-center justify-end space-x-4">
                            <button type="button" onclick="showPage(currentUser.role === 'siswa' ? 'beranda-siswa' : 'admin-dashboard')" class="px-6 py-2 text-sm font-medium text-slate-200 bg-slate-600 rounded-lg hover:bg-slate-500 transition-colors">Batal</button>
                            <button type="submit" class="px-6 py-2 text-sm font-medium text-white bg-blue-600 rounded-lg hover:bg-blue-700 transition-colors">Kirim Laporan</button>
                        </div>
                    </form>
                </div>
            </div>
            
            <!-- Riwayat Siswa Page -->
            <div id="riwayat-siswa" class="page">
                 <div class="bg-slate-800 p-6 md:p-8 rounded-xl shadow-lg">
                    <h2 class="text-2xl font-bold mb-6 text-white">Riwayat Laporan Anda</h2>
                    <div id="history-list" class="space-y-4"></div>
                 </div>
            </div>
            
            <!-- Pengaturan Page -->
            <div id="pengaturan" class="page">
                <div class="bg-slate-800 p-6 md:p-8 rounded-xl shadow-lg">
                    <h2 class="text-2xl font-bold mb-6 text-white">Pengaturan Profil</h2>
                    <div class="space-y-4">
                        <div>
                            <label for="nama-pengguna" class="block text-sm font-medium text-slate-300">Nama Pengguna</label>
                            <input type="text" id="nama-pengguna" class="mt-1 block w-full p-2 bg-slate-700 border border-slate-600 text-white rounded-md" placeholder="Masukkan nama Anda">
                        </div>
                         <div class="flex items-center justify-end space-x-4 pt-4">
                            <button onclick="saveProfile()" class="px-6 py-2 text-sm font-medium text-white bg-blue-600 rounded-lg hover:bg-blue-700 transition-colors">Simpan Perubahan</button>
                        </div>
                    </div>
                </div>
            </div>
        </main>
        
        <div id="toast-container" class="toast"></div>

    </div>

    <!-- Image Viewer Modal -->
    <div id="image-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-slate-800 p-4 rounded-lg max-w-3xl max-h-[90vh] relative">
            <button onclick="closeImageModal()" class="absolute -top-3 -right-3 bg-red-600 text-white rounded-full h-8 w-8 flex items-center justify-center text-2xl leading-none">&times;</button>
            <img id="modal-image" src="" alt="Lampiran Gambar" class="max-w-full max-h-[85vh] object-contain rounded-md">
        </div>
    </div>

    <script>
        let users;
        let complaintChart;
        let currentUser = null;
        
        const categories = [
            { name: 'Fasilitas', icon: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>' },
            { name: 'Pembelajaran', icon: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path><path d="M6.5 2H20v15H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path></svg>' },
            { name: 'Lingkungan', icon: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21.2,12.3l-5.7-5.7c-0.6-0.6-1.5-0.6-2.1,0L3.6,16.4c-0.5,0.5-0.6,1.3-0.3,2s1.1,1.1,1.9,0.8l4.8-1.8 c1.3-0.5,2.7,0.7,2.2,2l-1.8,4.8c-0.3,0.8,0.3,1.6,1.1,1.9c0.8,0.3,1.6-0.3,1.9-1.1l5.7-15.7C22.4,13.8,21.8,12.9,21.2,12.3z"></path></svg>' },
            { name: 'Perilaku Guru', icon: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>' },
            { name: 'Lainnya', icon: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="1"></circle><circle cx="19" cy="12" r="1"></circle><circle cx="5" cy="12" r="1"></circle></svg>' }
        ];

        // --- DATA HANDLING ---
        function getComplaints() { return JSON.parse(localStorage.getItem('complaints_v3')) || []; }
        function saveComplaints(complaints) { localStorage.setItem('complaints_v3', JSON.stringify(complaints)); }
        function getUsers() {
            const storedUsers = localStorage.getItem('app_users_v3');
            if (storedUsers) return JSON.parse(storedUsers);
            const defaultUsers = {
                students: [
                    { id: 'Nai', password: '12345', name: 'Naifah', role: 'siswa' },
                    { id: 'Raden', password: '354', name: 'M.Fikri', role: 'siswa' },
                    { id: 'Maira', password: '1122', name: 'Mairaa', role: 'siswa' },
                    { id: 'Aira', password: '1421', name: 'Aira', role: 'siswa' },
                ],
                admins: [{ id: 'walikelas', password: '123', name: 'Admin Sekolah', role: 'admin' }]
            };
            localStorage.setItem('app_users_v3', JSON.stringify(defaultUsers));
            return defaultUsers;
        }
        function saveUsers(updatedUsers) { localStorage.setItem('app_users_v3', JSON.stringify(updatedUsers)); }

        // --- UTILITY FUNCTIONS ---
        const getStatusInfo = (status) => {
            switch (status) {
                case 'Diterima': return { text: 'Diterima', color: 'bg-blue-500/20 text-blue-300' };
                case 'Diproses': return { text: 'Diproses', color: 'bg-yellow-500/20 text-yellow-300' };
                case 'Selesai': return { text: 'Selesai', color: 'bg-green-500/20 text-green-300' };
                default: return { text: 'Diterima', color: 'bg-slate-500/20 text-slate-300' };
            }
        };

        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast-container');
            toast.textContent = message;
            toast.className = `toast show ${type}`;
            setTimeout(() => { toast.classList.remove('show'); }, 3000);
        }
        
        // --- PAGE NAVIGATION ---
        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');
            
            if (pageId === 'riwayat-siswa') renderStudentHistory();
            if (pageId === 'admin-dashboard') renderAdminDashboard();
            if (pageId === 'grafik') updateChart();
            if (pageId === 'pengaturan') loadProfile();
            if (pageId === 'manajemen-akun') renderUserManagementPage();
        }

        function showComplaintForm(category) {
            showPage('form-laporan');
            document.getElementById('form-category-title').textContent = category;
            document.getElementById('category-input').value = category;
            document.getElementById('complaint-form').reset();
        }

        // --- AUTHENTICATION & UI SETUP ---
        function handleLogin(event) {
            event.preventDefault();
            const userId = document.getElementById('user-id').value;
            const password = document.getElementById('password').value;
            const loginError = document.getElementById('login-error');
            const foundUser = [...users.students, ...users.admins].find(user => user.id === userId && user.password === password);

            if (foundUser) {
                currentUser = foundUser;
                loginError.classList.add('hidden');
                document.getElementById('login-form').reset();
                initializeAppUI(currentUser);
            } else {
                loginError.textContent = 'NIS/ID atau password salah.';
                loginError.classList.remove('hidden');
            }
        }

        function handleManagementLogin(event) {
            event.preventDefault();
            const userId = document.getElementById('user-id').value;
            const password = document.getElementById('password').value;
            const loginError = document.getElementById('login-error');

            if (!userId || !password) {
                loginError.textContent = 'Silakan isi ID dan password admin terlebih dahulu.';
                loginError.classList.remove('hidden');
                return;
            }

            const foundUser = users.admins.find(user => user.id === userId && user.password === password);

            if (foundUser) {
                currentUser = foundUser;
                loginError.classList.add('hidden');
                document.getElementById('login-form').reset();
                initializeAppUI(currentUser);
                showPage('manajemen-akun');
            } else {
                loginError.textContent = 'Akses ditolak. Hanya admin yang bisa mengakses halaman ini.';
                loginError.classList.remove('hidden');
            }
        }

        function initializeAppUI(user) {
            document.getElementById('app-header').classList.remove('hidden');
            document.getElementById('welcome-message').textContent = `Selamat datang, ${user.name}!`;
            setupNavbar();
            if (user.role === 'siswa') {
                showPage('beranda-siswa');
            } else {
                setupAdminFilters();
                showPage('admin-dashboard');
            }
        }
        
        function logout() {
            currentUser = null;
            document.getElementById('app-header').classList.add('hidden');
            showPage('login');
        }

        function setupNavbar() {
            const nav = document.getElementById('app-nav');
            const settingsBtn = document.getElementById('pengaturan-btn');
            nav.innerHTML = '';
            if (currentUser.role === 'siswa') {
                nav.innerHTML = `<div class="flex space-x-2 md:space-x-4">
                    <button onclick="showPage('beranda-siswa')" class="nav-button text-slate-300 hover:text-white font-medium p-2 rounded-md hover:bg-slate-700 transition-colors">Beranda</button>
                    <button onclick="showPage('riwayat-siswa')" class="nav-button text-slate-300 hover:text-white font-medium p-2 rounded-md hover:bg-slate-700 transition-colors">Riwayat</button>
                    <button onclick="showPage('grafik')" class="nav-button text-slate-300 hover:text-white font-medium p-2 rounded-md hover:bg-slate-700 transition-colors">Grafik</button>
                </div>`;
                settingsBtn.style.display = 'block';
            } else if (currentUser.role === 'admin') {
                nav.innerHTML = `<div class="flex space-x-2 md:space-x-4">
                    <button onclick="showPage('admin-dashboard')" class="nav-button text-slate-300 hover:text-white font-medium p-2 rounded-md hover:bg-slate-700 transition-colors">Dasbor</button>
                    <button onclick="showPage('manajemen-akun')" class="nav-button text-slate-300 hover:text-white font-medium p-2 rounded-md hover:bg-slate-700 transition-colors">Manajemen Akun</button>
                    <button onclick="showPage('grafik')" class="nav-button text-slate-300 hover:text-white font-medium p-2 rounded-md hover:bg-slate-700 transition-colors">Grafik</button>
                </div>`;
                settingsBtn.style.display = 'none';
            }
        }

        // --- FORM SUBMISSION ---
        function submitComplaint(event) {
            event.preventDefault();
            const attachmentFile = document.getElementById('attachment').files[0];
            
            const processSubmit = (attachmentData = null) => {
                const complaints = getComplaints();
                const newComplaint = {
                    id: Date.now(),
                    reporterId: currentUser.id,
                    category: document.getElementById('category-input').value,
                    problem: document.getElementById('masalah').value,
                    attachmentName: attachmentFile ? attachmentFile.name : null,
                    attachmentData: attachmentData,
                    isAnonymous: document.getElementById('anonim').checked,
                    reporterName: document.getElementById('anonim').checked ? 'Anonim' : currentUser.name,
                    date: new Date().toISOString(),
                    status: 'Diterima',
                    followUp: 'Laporan Anda telah kami terima dan akan segera ditindaklanjuti.',
                    followUpAttachmentName: null,
                    followUpAttachmentData: null
                };
                complaints.unshift(newComplaint);
                saveComplaints(complaints);
                showToast('Laporan berhasil dikirim!');
                showPage('beranda-siswa');
            };

            if (attachmentFile) {
                const reader = new FileReader();
                reader.onload = (e) => processSubmit(e.target.result);
                reader.readAsDataURL(attachmentFile);
            } else {
                processSubmit();
            }
        }

        // --- DYNAMIC CONTENT RENDERING ---
        function renderCategoryButtons() {
            const container = document.getElementById('category-buttons');
            container.innerHTML = '';
            categories.forEach(cat => {
                const button = document.createElement('button');
                button.className = 'category-card bg-slate-800 p-4 rounded-xl shadow-lg hover:bg-slate-700 hover:scale-105 transition-all duration-300 text-center flex flex-col items-center justify-center space-y-2';
                button.onclick = () => showComplaintForm(cat.name);
                button.innerHTML = `<div class="text-blue-400">${cat.icon}</div> <p class="font-semibold text-base text-white">${cat.name}</p>`;
                container.appendChild(button);
            });
        }
        
        function setupAdminFilters() {
            const filterCategory = document.getElementById('filter-category');
            filterCategory.innerHTML = '<option value="">Semua Kategori</option>';
            categories.forEach(cat => {
                const option = document.createElement('option');
                option.value = cat.name;
                option.textContent = cat.name;
                filterCategory.appendChild(option);
            });
        }

        function renderAdminStats(complaints) {
            const container = document.getElementById('admin-stats');
            const total = complaints.length;
            const diproses = complaints.filter(c => c.status === 'Diproses').length;
            const selesai = complaints.filter(c => c.status === 'Selesai').length;
            container.innerHTML = `
                <div class="bg-slate-900/50 p-4 rounded-lg"><p class="text-sm text-slate-400">Total Laporan</p><p class="text-2xl font-bold">${total}</p></div>
                <div class="bg-slate-900/50 p-4 rounded-lg"><p class="text-sm text-slate-400">Laporan Diproses</p><p class="text-2xl font-bold">${diproses}</p></div>
                <div class="bg-slate-900/50 p-4 rounded-lg"><p class="text-sm text-slate-400">Laporan Selesai</p><p class="text-2xl font-bold">${selesai}</p></div>`;
        }

        function renderHistoryItemAttachment(item) {
            if (!item.attachmentData) return '';
            return `<div class="mt-2">
                <button onclick="showImageModal(${item.id}, 'student')" class="text-xs font-medium text-blue-400 hover:text-blue-300 bg-slate-700 px-3 py-1 rounded-full flex items-center space-x-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"></path></svg>
                    <span>Lihat Lampiran: ${item.attachmentName}</span>
                </button>
            </div>`;
        }

        function renderFollowUpAttachment(item, role) {
            if (!item.followUpAttachmentData) return '';
            const text = role === 'student' ? `Lampiran Admin: ${item.followUpAttachmentName}` : `Lihat Lampiran: ${item.followUpAttachmentName}`;
            return `<div class="mt-2">
                 <button onclick="showImageModal(${item.id}, 'admin')" class="text-xs font-medium text-green-400 hover:text-green-300 bg-slate-600 px-3 py-1 rounded-full flex items-center space-x-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"></path></svg>
                    <span>${text}</span>
                 </button>
            </div>`;
        }


        function renderStudentHistory() {
            const historyList = document.getElementById('history-list');
            const myComplaints = getComplaints().filter(c => c.reporterId === currentUser.id);
            historyList.innerHTML = myComplaints.length === 0 ? `<p class="text-center text-slate-400">Anda belum membuat laporan.</p>` : '';
            if (myComplaints.length === 0) return;

            myComplaints.forEach(item => {
                const status = getStatusInfo(item.status);
                const itemDate = new Date(item.date);
                const formattedDate = itemDate.toLocaleDateString('id-ID', { day: '2-digit', month: 'long', year: 'numeric' }) + ', ' + itemDate.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' });
                const element = document.createElement('div');
                element.className = 'border border-slate-700 p-4 rounded-lg transition-all hover:border-slate-600';
                element.innerHTML = `
                    <div class="flex justify-between items-start mb-2">
                        <div><p class="font-bold text-slate-100">${item.category}</p><p class="text-xs text-slate-400">Dikirim pada: ${formattedDate}</p></div>
                        <span class="text-xs font-medium px-2.5 py-0.5 rounded-full ${status.color}">${status.text}</span>
                    </div>
                    <p class="text-slate-300 mb-3">${item.problem}</p>
                    ${renderHistoryItemAttachment(item)}
                    <div class="bg-slate-700/50 border-t border-slate-700 p-3 mt-3 rounded-b-lg">
                        <p class="text-sm font-semibold text-slate-200">Tindak Lanjut Sekolah:</p>
                        <p class="text-sm text-slate-300 italic mt-1">${item.followUp}</p>
                        ${renderFollowUpAttachment(item, 'student')}
                    </div>`;
                historyList.appendChild(element);
            });
        }

        function renderAdminDashboard() {
            const adminList = document.getElementById('admin-history-list');
            let complaints = getComplaints();
            const searchTerm = document.getElementById('search-input').value.toLowerCase();
            const filterCategory = document.getElementById('filter-category').value;
            const filterStatus = document.getElementById('filter-status').value;

            if (searchTerm) complaints = complaints.filter(c => c.problem.toLowerCase().includes(searchTerm) || c.reporterName.toLowerCase().includes(searchTerm));
            if (filterCategory) complaints = complaints.filter(c => c.category === filterCategory);
            if (filterStatus) complaints = complaints.filter(c => c.status === filterStatus);
            
            renderAdminStats(complaints);
            adminList.innerHTML = complaints.length === 0 ? `<p class="text-center text-slate-400">Tidak ada laporan yang cocok dengan filter.</p>` : '';
            if (complaints.length === 0) return;

            complaints.forEach(item => {
                const itemDate = new Date(item.date);
                const formattedDate = itemDate.toLocaleDateString('id-ID', { day: '2-digit', month: 'long', year: 'numeric' });
                const element = document.createElement('div');
                element.className = 'border border-slate-700 p-4 rounded-lg';
                element.innerHTML = `
                    <div class="flex justify-between items-start mb-2">
                        <div><p class="font-bold text-slate-100">${item.category}</p><p class="text-xs text-slate-400">Oleh: ${item.reporterName} â€¢ ${formattedDate}</p></div>
                        <select id="status-${item.id}" class="text-xs font-medium bg-slate-700 border-slate-600 text-white rounded-md focus:ring-blue-500 focus:border-blue-500">
                            <option value="Diterima" ${item.status === 'Diterima' ? 'selected' : ''}>Diterima</option>
                            <option value="Diproses" ${item.status === 'Diproses' ? 'selected' : ''}>Diproses</option>
                            <option value="Selesai" ${item.status === 'Selesai' ? 'selected' : ''}>Selesai</option>
                        </select>
                    </div>
                    <p class="text-slate-300 mb-3">${item.problem}</p>
                    ${renderHistoryItemAttachment(item)}
                    <div class="bg-slate-700/50 border-t border-slate-700 p-3 mt-3 rounded-b-lg">
                        <label for="followup-${item.id}" class="text-sm font-semibold text-slate-200">Tindak Lanjut Sekolah:</label>
                        <textarea id="followup-${item.id}" rows="2" class="w-full mt-1 p-2 text-sm bg-slate-700 border border-slate-600 text-white rounded-lg">${item.followUp}</textarea>
                        <div class="mt-2">
                            <label for="followup-attachment-${item.id}" class="text-xs font-medium text-slate-300">Lampirkan Foto Tindak Lanjut (Opsional)</label>
                            <input type="file" id="followup-attachment-${item.id}" accept="image/*" class="w-full text-sm text-slate-400 file:mr-4 file:py-1 file:px-3 file:rounded-full file:border-0 file:text-xs file:font-semibold file:bg-blue-500/10 file:text-blue-300 hover:file:bg-blue-500/20">
                            ${renderFollowUpAttachment(item, 'admin')}
                        </div>
                        <button onclick="updateComplaint(${item.id})" class="mt-2 px-4 py-1 text-xs font-medium text-white bg-blue-600 rounded-lg hover:bg-blue-700">Simpan Tindak Lanjut</button>
                    </div>`;
                adminList.appendChild(element);
            });
        }

        // --- CHART FUNCTIONS ---
        function initializeChart() {
            Chart.defaults.color = '#cbd5e1'; 
            Chart.defaults.borderColor = '#475569';
            const ctx = document.getElementById('complaintChart').getContext('2d');
            complaintChart = new Chart(ctx, {
                type: 'bar',
                data: { labels: categories.map(c => c.name), datasets: [{ label: 'Jumlah Laporan', data: getComplaintCounts(), backgroundColor: ['rgba(59, 130, 246, 0.6)','rgba(239, 68, 68, 0.6)','rgba(245, 158, 11, 0.6)','rgba(16, 185, 129, 0.6)','rgba(107, 114, 128, 0.6)'], borderColor: ['#3b82f6','#ef4444','#f59e0b','#10b981','#6b7280'], borderWidth: 1 }] },
                options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } }, plugins: { legend: { display: false } } }
            });
        }
        function getComplaintCounts() {
            const complaints = getComplaints(); const counts = {};
            categories.forEach(cat => counts[cat.name] = 0);
            complaints.forEach(c => { if(counts.hasOwnProperty(c.category)) { counts[c.category]++; } });
            return Object.values(counts);
        }
        function updateChart() {
            if (complaintChart) {
                complaintChart.data.datasets[0].data = getComplaintCounts();
                complaintChart.update();
            }
        }
        
        // --- ADMIN ACTIONS ---
        function updateComplaint(id) {
            const attachmentFile = document.getElementById(`followup-attachment-${id}`).files[0];

            const processUpdate = (attachmentData = null) => {
                const complaints = getComplaints();
                const complaintIndex = complaints.findIndex(c => c.id === id);
                if (complaintIndex > -1) {
                    complaints[complaintIndex].status = document.getElementById(`status-${id}`).value;
                    complaints[complaintIndex].followUp = document.getElementById(`followup-${id}`).value;
                    if (attachmentFile) {
                        complaints[complaintIndex].followUpAttachmentName = attachmentFile.name;
                        complaints[complaintIndex].followUpAttachmentData = attachmentData;
                    }
                    saveComplaints(complaints);
                    showToast('Laporan berhasil diperbarui!');
                    renderAdminDashboard();
                }
            };
            
            if (attachmentFile) {
                const reader = new FileReader();
                reader.onload = (e) => processUpdate(e.target.result);
                reader.readAsDataURL(attachmentFile);
            } else {
                // If no *new* file is selected, we must preserve the old one if it exists
                const existingComplaint = getComplaints().find(c => c.id === id);
                processUpdate(existingComplaint.followUpAttachmentData);
            }
        }
        
        function addStudent(event) {
            event.preventDefault();
            const name = document.getElementById('new-student-name').value;
            const id = document.getElementById('new-student-id').value;
            const password = document.getElementById('new-student-password').value;

            if (users.students.some(s => s.id === id)) {
                showToast('NIS sudah terdaftar.', 'error');
                return;
            }

            users.students.push({ id, password, name, role: 'siswa' });
            saveUsers(users);
            showToast('Akun siswa berhasil ditambahkan.');
            document.getElementById('add-user-form').reset();
            renderUserManagementPage();
        }

        function deleteStudent(studentId) {
            users.students = users.students.filter(s => s.id !== studentId);
            saveUsers(users);
            showToast('Akun siswa berhasil dihapus.');
            renderUserManagementPage();
        }

        function renderUserManagementPage() {
            const container = document.getElementById('student-list-container');
            container.innerHTML = '';
            users.students.forEach(student => {
                const element = document.createElement('div');
                element.className = 'flex justify-between items-center p-3 bg-slate-700/50 rounded-lg';
                element.innerHTML = `
                    <div>
                        <p class="font-semibold">${student.name}</p>
                        <p class="text-sm text-slate-400">NIS: ${student.id}</p>
                    </div>
                    <button onclick="deleteStudent('${student.id}')" class="px-3 py-1 text-xs text-white bg-red-600 hover:bg-red-700 rounded-md">Hapus</button>
                `;
                container.appendChild(element);
            });
        }

        // --- PROFILE & MODAL ---
        function loadProfile() {
            document.getElementById('nama-pengguna').value = currentUser.name;
        }

        function saveProfile() {
            const newName = document.getElementById('nama-pengguna').value;
            if (!newName.trim()) { showToast('Nama tidak boleh kosong', 'error'); return; }
            currentUser.name = newName;
            const userInDb = users.students.find(u => u.id === currentUser.id) || users.admins.find(u => u.id === currentUser.id);
            if (userInDb) userInDb.name = newName;
            saveUsers(users);
            document.getElementById('welcome-message').textContent = `Selamat datang, ${newName}!`;
            showToast('Profil berhasil disimpan!');
            showPage('beranda-siswa');
        }

        function showImageModal(complaintId, type) {
            const complaint = getComplaints().find(c => c.id == complaintId);
            if (!complaint) return;
            const data = (type === 'student') ? complaint.attachmentData : complaint.followUpAttachmentData;
            if (data) {
                document.getElementById('modal-image').src = data;
                document.getElementById('image-modal').classList.remove('hidden');
            } else {
                showToast('Lampiran tidak dapat ditampilkan.', 'error');
            }
        }

        function closeImageModal() {
            document.getElementById('image-modal').classList.add('hidden');
            document.getElementById('modal-image').src = '';
        }

        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            users = getUsers();
            renderCategoryButtons();
            initializeChart();
            showPage('login');
        });
    </script>
</body>
</html>

